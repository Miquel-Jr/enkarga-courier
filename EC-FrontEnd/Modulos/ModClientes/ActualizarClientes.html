<form id="buscarCliente" class="">
  <div class="card">
    <h5 class="card-header h5">Buscar Cliente</h5>
    <div class="card-body">
      <div class="form-row">
        <div class="col-12 col-md-12 form-group text-center">
          <label class="col-form-label font-weight-bold" for="clienteBuscador">Cliente</label>
          <select class="form-control w-50 mx-auto selectpicker" data-live-search="true" id="cliente"></select>
          <small id="clienteBuscadorHelp" class="form-text text-muted">Ejemplo: Jorge.</small>
        </div>
      </div>
    </div>
  </div>

  <div class="form-inline justify-content-center">
    <button type="button" onclick="mostrarLoader();return false" class="btn btn-guardar disabled" id="buscarClienteButton">
      Buscar
    </button>
  </div>
</form>

<!--DISEÑO GENERAL DE LA VISTA-->
<form id="datosCliente" class="d-none">
  <!--DATOS GENERALES-->
  <div class="card">
    <div class="card-body">
      <div class="row justify-content-center">
        <!--TITULO DE LA VISTA-->
        <div class="col-12 col-md-8 text-center">
          <h3 class="h3-responsive titulo font-weight-bold">Actualizar Datos del cliente</h3>
        </div>

        <div class="w-100"></div>

        <!--INFORMACION GENERAL DEL CLIENTE-->
        <div class="col-12 col-md-5 col-xl-4 form-group text-center">
          <!--CODIGO-->
          <h6>Codigo: <span id="codigo">000000</span></h6>

          <!--F. REGISTRO EN EL SISTEMA-->
          <h6>Fecha de registro: <span id="fechaRegistro"></span></h6>
        </div>
      </div>
    </div>
  </div>

  <!--DATOS PERSONALES-->
  <div class="card">
    <h5 class="card-header h5">Datos Personales</h5>
    <div class="card-body">
      <div class="form-row">
        <!-- NOMBRES -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="nombres">Nombres</label>
          <input required id="nombres" onkeyup="obtenerMayuscula(this);" class="form-control" type="string"
            aria-describedby="nombresHelp" placeholder="Ingresar nombres del cliente" />
          <small id="nombresHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <!--APELLIDOS -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="apellidos">Apellidos</label>
          <input required id="apellidos" onkeyup="obtenerMayuscula(this);" class="form-control" type="string"
            aria-describedby="apellidosHelp" placeholder="Ingresar apellidos del cliente" />
          <small id="apellidosHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="w-100"></div>

        <!--TIPO DE DOCUMENTO -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="tipoDocumento">Tipo de documento</label>
          <select required id="tipoDocumento" class="form-control" aria-describedby="tipoDocumentoHelp"></select>
          <small id="tipoDocumentoHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <!--NUMERO DE DOCUMENTO  -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="numeroDocumento">Nro de Documento</label>
          <input required id="numeroDocumento" onkeyup="obtenerMayuscula(this);" class="form-control" type="string"
            aria-describedby="numeroDocumentoHelp" placeholder="Ingresar numero de documento" min="1"
            oninput="javascript: if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
            maxlength="20" />
          <small id="numeroDocumentoHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="w-100"></div>

        <!--CORREO  -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="correo">Correo</label>
          <input id="correo" class="form-control" type="string" aria-describedby="correoHelp"
            placeholder="Ingresar correo del cliente" />
          <small id="correoHelp" class="form-text text-muted">Campo opcional.</small>
        </div>

        <!-- TELEFONO -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="telefono">Telefono</label>
          <input id="telefono" class="form-control" type="string" aria-describedby="telefonoHelp"
            placeholder="Ingresar telefono del cliente" />
          <small id="telefonoHelp" class="form-text text-muted">Campo opcional.</small>
        </div>

        <!-- CELULAR -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold"  for="celular">Celular</label>
          <input id="celular" class="form-control" type="string" aria-describedby="celularHelp"
            placeholder="Ingresar celular del cliente" />
          <small id="celularHelp" class="form-text text-muted">Campo opcional.</small>
        </div>

        <div class="w-100"></div>

        <!--ESTADO -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="estado">Estado</label>
          <select required id="estado" class="form-control"></select>
        </div>

      </div>
    </div>
  </div>

  <!--DATOS -->
  <div class="card">
    <h5 class="card-header h5">Cliente - Sucursal</h5>
    <div class="card-body">
      <div class="form-row">

        <!-- DEPARTAMENTO -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="departamento">Departamento</label>
          <select required id="departamento" onchange="cargarProvincia(this.value);" class="form-control"
            aria-describedby="departamentoHelp"></select>
          <small id="departamentoHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <!-- PROVINCIA -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="provincia">Provincia</label>
          <select required id="provincia" onchange="cargarDistrito(this.value);" class="form-control"
            aria-describedby="provinciaHelp"></select>
          <small id="provinciaHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <!-- DISTRITO -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="distrito">Distrito</label>
          <select required id="distrito" class="form-control" aria-describedby="distritoHelp"></select>
          <small id="distritoHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="w-100"></div>

        <!--DIRECCION SUCURSAL-->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="direccion">Direccion</label>
          <input required id="direccion" class="form-control" type="string" aria-describedby="direccionHelp"
            placeholder="Ingresar direccion de la sucursal" onchange="mostrarRegistroSucursal()" />
          <small id="direccionHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="ruc">Ruc</label>
          <input required class="form-control" id="ruc" type="number" min="1"
            oninput="if (this.value.length > this.maxLength) this.value = this.value.slice(0, this.maxLength);"
            maxlength="11" onchange="mostrarRegistroSucursal()" placeholder="Ingresar ruc de la sucursal"
            aria-describedby="rucHelp">
          <small id="rucHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="razonSocial">Razon Social</label>
          <input required class="form-control" id="razonSocial" type="text" onchange="mostrarRegistroSucursal()"
            placeholder="Ingresar razon social de la sucursal" aria-describedby="razonSocialHelp">
          <small id="razonSocialHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <div class="col-12 text-right mb-3">
          <button id="clear" class="btn btn-clear" onclick="return false">Limpiar</button>
          <button id="registrarSucursal" onclick="return false" class="btn btn-default">Agregar</button>
        </div>
        <div class="col-12">

          <table id="tablaSucursales" class="table table-striped table-bordered" cellspacing="0" width="100%">
            <thead>
              <tr>
                <th class='th-sm' width="15%">DISTRITO</th>
                <th class='th-sm' width="40%">DIRECCION</th>
                <th class='th-sm' width="20%">RUC</th>
                <th class='th-sm' width="20%">RAZON SOCIAL</th>
                <th class='th-sm' width="5%">ACCIONES</th>
              </tr>
            </thead>
            <tbody id="cuerpoTablaSucursales">
              <tr>
              </tr>
            </tbody>
          </table>
        </div>
        <div class="w-100"></div>

      </div>
    </div>
  </div>


  <!--OPCIONES DEL FORMULARIO-->
  <div id="opcionesFormulario" class="form-inline justify-content-center">
    <button type="button" id="guardar" onclick="mostrarLoaderActualizar();return false" class="btn btn-guardar">
      Actualizar
    </button>
    <button type="reset" id="reset" class="btn btn-reset">Reestablecer</button>
  </div>
</form>

<div id="loader"></div>
<!--ARCHIVOS JS DE LA VISTA-->
<script src="Bootstrap/js/select2.min.js"></script>
<link href="Bootstrap/css/select2.min.css" rel="stylesheet" />
<script type="text/javascript" src="Modulos/ModClientes/VistaClientes.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/validator/13.6.0/validator.min.js"></script>

<script type="text/javascript">

  var sucursales = []

  mostrarListadoClientes();
  cargarDepartamento();
  cargarProvincia(false);
  cargarDistrito(false);

  /*=============================================
    - MOSTRAR CLIENTES
  =============================================*/

  async function mostrarListadoClientes() {
    const datos = await cargarDatosListadoClientes();
    var tablaClientes =
      "<option value = 0 selected disabled> Elegir Cliente</option>";
    if (Array.isArray(datos)) {
      for (const cliente of datos) {
        tablaClientes += `
          <option value=${cliente.id_cliente}>
            ${cliente.nombres} ${cliente.apellidos}
          </option>
        `;
      }
    }
    $("#cliente").html(tablaClientes);
    $("#cliente").select2();
  }

  /*=============================================
    - MOSTRAR BUSCAR CLIENTE
  =============================================*/
  $("#cliente").change(function () {
    const idCliente = $("#cliente").val();
    if (idCliente !== 0) {
      document.getElementById("buscarClienteButton").classList.remove("disabled");
    }
  });

  /*=============================================
    - RESET FORMULARIO
  =============================================*/
  $("#reset").click(function () {
    mostrarDatosCliente();
  });

  /*=============================================
    - RESET SUCURSAL
  =============================================*/

  $("#clear").click(function () {
    cargarDepartamento();
    cargarProvincia(false);
    cargarDistrito(false);
    $("#direccion").val("");
    $("#ruc").val("");
    $("#razonSocial").val("");
  });

  /*=============================================
    - AGREGAR SUCURSAL
  =============================================*/

  $("#registrarSucursal").click(function () {
    registrarListadoSucursal();
  });
  /*=============================================
    - MOSTRAR LOADER
  =============================================*/
  function mostrarLoader() {
    document.getElementById("loader").style.display = "block";
    setTimeout(mostrarDatosCliente, 1500);
  }

  function mostrarLoaderActualizar() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarCampos, 1500);
  }

  /*=============================================
    - CERRAR LOADER
  =============================================*/
  function cerrarLoader() {
    document.getElementById("loader").style.display = "none";
  }

  /*=============================================
    - MOSTRAR DATOS DEL CLIENTE
  =============================================*/

  async function mostrarDatosCliente() {
    await cargarTipoDocumentos();
    await cargarEstados();

    const datos = await cargarDatosCliente({
      _idCliente: $("#cliente").val(),
    });

    cerrarLoader();
    if (datos.response == "0") {
      Swal.fire({
        icon: "warning",
        title: "Cliente no encontrado",
        text: datos.message
      });
    } else {

      const listadoSucursales = await mostradoListadoSucursal({
        _idCliente: $("#cliente").val()
      });
      if (listadoSucursales.response !== 0) {
        sucursales = listadoSucursales.concat(sucursales);
      }
      document.getElementById("datosCliente").classList.remove("d-none");
      document.getElementById("buscarCliente").classList.add("d-none");
      $("#codigo").html(datos.id_cliente);
      $("#fechaRegistro").html(datos.fecha_registro);
      $("#nombres").val(datos.nombres);
      $("#apellidos").val(datos.apellidos);
      $(`#tipoDocumento option[value=${datos.tipo_documento}]`).attr("selected", true);
      $("#numeroDocumento").val(datos.numero_documento);
      $("#correo").val(datos.correo);
      $("#telefono").val(datos.telefono);
      $("#celular").val(datos.celular);
      $("#estado").val(datos.id_estado);
      mostrarListadoSucursales();
    }
  }

  /*=============================================
    - VALIDAR FORMULARIO
  =============================================*/

  async function validarCampos() {
    const idCliente = $("#codigo").html();
    const nombres = $("#nombres").val().trim();
    const apellidos = $("#apellidos").val().trim();
    const tipoDocumento = $("#tipoDocumento").val();
    const numeroDocumento = $("#numeroDocumento").val();
    const correo = $("#correo").val();
    const celular = $("#celular").val();
    const telefono = $("#telefono").val();
    const estado = $("#estado").val();

    const info = {
      icon: "error",
      title: "Campo Inválido",
    };

    if (!validator.isLength(nombres, { min: 1 })) {
      info.text = "El campo nombres no debe estar vacio";
    } else if (!validator.isLength(apellidos, { min: 1 })) {
      info.text = "El campo apellido no debe estar vacio";
    } else if (!validator.isLength(numeroDocumento, { min: 8 })) {
      info.text =
        "El campo numero documento debe tener 8 caracteres como minimo";
    } else if (correo && !validator.isEmail(correo)) {
      info.text = "El campo correo debe ser un correo válido";
    } else if (
      celular &&
      !validator.isLength(celular, { min: 1 }) &&
      !validator.isNumeric(celular)
    ) {
      info.text = "El campo celular debe ser numérico";
    } else if (
      telefono &&
      !validator.isLength(telefono, { min: 1 }) &&
      !validator.isNumeric(telefono)
    ) {
      info.text = "El campo telefono debe ser numérico";
    } else if (sucursales.length === 0) {
      info.text = "No hay sucursales registrados";
    }

    if (info.text) {
      cerrarLoader();
      Swal.fire(info);
      return false;
    }

    actualizarDatosCliente({
      _idCliente: Number(idCliente),
      _nombres: nombres,
      _apellidos: apellidos,
      _tipoDocumento: tipoDocumento,
      _numeroDocumento: numeroDocumento,
      _correo: correo,
      _telefono: telefono,
      _celular: celular,
      _idEstado: estado
    });
  }

  /*=============================================
    - ACTUALIZAR CLIENTE
  =============================================*/

  async function actualizarDatosCliente($cliente) {
    const vCliente = await validarCliente($cliente);
    if (vCliente.id_cliente !== $cliente._idCliente) {
      cerrarLoader();
      Swal.fire({
        icon: "warning",
        title: "Cliente encontrado",
        text: `El numero de documento existe con el nombre de: ${vCliente.nombres} ${vCliente.apellidos}`,
      });
      return false;
    }

    await actualizarCliente($cliente);
    await eliminarListadoSucursal($cliente);
    await registrarListadoSucursalCliente({
      _idCliente: $cliente._idCliente,
      _sucursales: sucursales
    });
    cerrarLoader();
    Swal.fire({
      icon: "success",
      title: "Cliente actualizado",
      text: `El cliente se actualizó corrrectamente`,
    });
  }

  /*=============================================
    - LISTADO SUCURSAL - TEMPORAL
  =============================================*/

  function mostrarListadoSucursales() {
    var tablaSucursales = "";
    for (const [index, sucursal] of sucursales.entries()) {
      tablaSucursales += `
        <tr>
          <td class="text-center">${sucursal.distrito}</td>
          <td class="text-center">${sucursal.direccion}</td>
          <td class="text-center">${sucursal.ruc}</td>
          <td class="text-center">${sucursal.razonSocial}</td>
          <td class="text-center">
            <button onclick="eliminarSucursal(${index})" class="btn btn-eliminar">Eliminar</button>
          </td>
        </tr>
      `;
    }
    $("#cuerpoTablaSucursales").html(tablaSucursales);
  }

  /*=============================================
    - ELIMINAR SUCURSAL - TEMPORAL
  =============================================*/

  function eliminarSucursal(id) {
    sucursales = sucursales.filter((item, index) => index !== id);
    mostrarListadoSucursales();
  }

  /*=============================================
    - REGISTRAR SUCURSAL - TEMPORAL
  =============================================*/

  function registrarListadoSucursal() {
    sucursales.push({
      idDistrito: $("#distrito").val(),
      distrito: $('#distrito option:selected').text().trim(),
      direccion: $("#direccion").val(),
      ruc: $("#ruc").val(),
      razonSocial: $("#razonSocial").val(),
    });
    cargarDepartamento();
    cargarProvincia(false);
    cargarDistrito(false);
    $("#direccion").val("")
    $("#ruc").val("")
    $("#razonSocial").val("");
    mostrarListadoSucursales();
    mostrarRegistroSucursal();
  }

  /*=============================================
    - MOSTRAR/OCULTAR REGISTRO SUCURSAL
  =============================================*/

  function mostrarRegistroSucursal() {
    const departamento = $("#departamento").val();
    const provincia = $("#provincia").val();
    const distrito = $("#distrito").val();
    const direccion = $("#direccion").val();
    const ruc = $("#ruc").val();
    const razonSocial = $("#razonSocial").val();
    if (departamento && provincia && distrito && direccion && ruc && razonSocial) {
      document.getElementById("registrarSucursal").classList.remove("disabled");
    } else {
      document.getElementById("registrarSucursal").classList.add("disabled");
    }
  }

</script>