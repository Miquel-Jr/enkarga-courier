<style>
  .carousel-container {
    overflow: hidden;
    margin: auto;
  }

  .carousel {
    display: flex;
    transition: transform 0.5s ease-in-out;
  }

  .form-card {
    width: 85%;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    border-radius: 8px;
    margin: 10px;
    padding: 20px;
    background-color: #fff;
    flex-shrink: 0;
  }

  .guia-list {
    list-style-type: none;
    max-height: 200px;
    overflow-y: auto;
  }

  .guia-list li {
    margin: 10px 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .guia-item {
    flex: 1;
    padding: 0 10px;
  }
</style>

<form id="buscarDatos" class="">
  <div class="card">
    <h5 class="card-header h5">Actualizar Factura</h5>
    <div class="card-body">
      <div class="form-row">
        <div class="col-12 col-md-12 form-group text-center">
          <label class="col-form-label font-weight-bold" for="factura">Factura</label>
          <select class="form-control w-50 mx-auto selectpicker" data-live-search="true" id="factura"></select>
          <small id="facturaHelp" class="form-text text-muted">Ejemplo: F001 - 00000012.</small>
        </div>
        <input type="hidden" id="estadoInicialFactura" value="0">
      </div>
    </div>
  </div>

  <div class="form-inline justify-content-center">
    <button type="button" onclick="mostrarLoader();return false" class="btn btn-guardar disabled"
      id="buscarFacturaButton">
      Buscar
    </button>
  </div>
</form>

<form id="informacionDatos" class="d-none">
  <!--DATOS PRINCIPALES-->
  <div class="card">
    <div class="card-body">
      <div class="row justify-content-center">
        <!--TITULO DE LA VISTA-->
        <div class="col-12 col-md-8 text-center">
          <h3 class="h3-responsive titulo font-weight-bold">Actualizar Datos Factura</h3>
        </div>

        <div class="w-100"></div>

        <!--INFORMACION GENERAL DEL CLIENTE-->
        <div class="col-12 col-md-5 col-xl-4 form-group text-center">
          <!--CODIGO-->
          <h6>Factura: <span id="codigo">000000</span></h6>

          <!--F. REGISTRO EN EL SISTEMA-->
          <h6>Fecha de registro: <span id="fechaRegistro"></span></h6>
        </div>
      </div>
    </div>
  </div>

  <!--DATOS GENERALES-->
  <div class="card">
    <h5 class="card-header h5">Datos Generales</h5>
    <div class="card-body">
      <div class="form-row">

        <!-- ESTADOS FACTURA -->
        <div class="col-12 col-md form-group">
          <label class="col-form-label font-weight-bold" for="estadosFactura">Estado Factura</label>
          <select class="form-control mx-auto selectpicker" data-live-search="true" id="estadosFactura"></select>
          <small id="estadosFacturaHelp" class="form-text text-muted">Campo obligatorio.</small>
        </div>

        <!-- ACTUALIZAR -->
        <button type="button" class="btn btn-default w-25 my-4 disabled" id="actualizarEstadoFactura"
          onclick="mostrarLoaderActualizarEstadoFactura();return false">
          Actualizar Estado Factura
        </button>

        <div class="w-100"></div>
      </div>
    </div>
  </div>
</form>

<div id="carousel-factura" class="carousel-container d-none">
  <div class="carousel" id="carousel">

    <!-- ESTADO 1 -->
    <form class="form-card">
      <!--DATOS GUIA-->
      <div class="card">
        <h5 class="card-header h5">Selección de guia</h5>
        <div class="card-body">
          <div class="form-row">
            <div class="col-12 mb-3">
              <h5>Seleccionar guía pendiente de factura</h5>
            </div>
            <div class="col-12 mb-3">
              <input type="text" class="form-control" id="buscarGuia" placeholder="Buscar guía..."
                onkeyup="filtrarGuias()">
            </div>
            <div class="col-12">
              <ul class="guia-list" id="guiaList">
              </ul>
            </div>
          </div>
        </div>
      </div>
      <!--DATOS FACTURA-->
      <div class="card">
        <h5 class="card-header h5">Datos Principales</h5>
        <div class="card-body">
          <div class="form-row">
            <!-- SERIE -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="serieFactura">Serie</label>
              <input required id="serieFactura" onkeyup="obtenerMayuscula(this);" class="form-control" type="string"
                aria-describedby="serieFacturaHelp" placeholder="Ingresar serie de la factura" />
              <small id="serieFacturaHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- NUMERO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="numeroFactura">Numero</label>
              <input required id="numeroFactura" onblur="autoCompletarCeros(this);" class="form-control" type="string"
                maxlength="8" aria-describedby="numeroFacturaHelp" placeholder="Ingresar numero de factura" />
              <small id="numeroFacturaHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- CLIENTE -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="cliente">Cliente</label>
              <select required id="cliente" class="form-control" aria-describedby="clienteHelp">
                <option value="0" selected disabled>Elegir Guia</option>
              </select>
              <small id="clienteHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>

            <!-- FECHA VENCIMIENTO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="fechaVencimiento">Fecha Vencimiento</label>
              <input required id="fechaVencimiento" class="form-control " type="date"
                aria-describedby="fechaVencimientoHelp" placeholder="Ingresar fecha de vencimiento" />
              <small id="fechaVencimientoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- TIPO DE CREDITO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="tipoCredito">Tipo de Crédito</label>
              <select required id="tipoCredito" class="form-control" aria-describedby="tipoCreditoHelp">
                <option value="CREDITO">CREDITO</option>
                <option value="CONTADO">CONTADO</option>
              </select>
              <small id="tipoCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- ORDEN DE SERVICIO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="ordenServicio">Orden de servicio</label>
              <input id="ordenServicio" class="form-control " type="number" aria-describedby="ordenServicioHelp"
                placeholder="Ingresar orden de servicio" />
              <small id="ordenServicioHelp" class="form-text text-muted">Campo opcional.</small>
            </div>

            <div class="w-100"></div>

            <!-- BASE IMPONIBLE -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="baseImponible">Base Imponible</label>
              <input required id="baseImponible" class="form-control " type="number" step="0.01"
                aria-describedby="baseImponibleHelp" placeholder="Ingresar base imponible de la factura" />
              <small id="ordenServicioHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>
            <!-- IGV -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="igv">IGV (18%)</label>
              <input required id="igv" class="form-control disabled" type="number" step="0.01"
                aria-describedby="igvHelp" placeholder="Igv calculado" />
              <small id="igvHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>
            <!-- SUB TOTAL -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="subTotal">Sub total</label>
              <input required id="subTotal" class="form-control " type="number" step="0.01"
                aria-describedby="subTotalHelp" placeholder="Sub total calulado" />
              <small id="subTotalHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>

            <!-- OCPION DETRACCION -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="usoDetraccion">Uso de Detraccion</label>
              <select required id="usoDetraccion" class="form-control" aria-describedby="usoDetraccionHelp">
                <option value="NO" selected>NO</option>
                <option value="SI">SI</option>
              </select>
              <small id="usoDetraccionHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- DETRACCION -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="detraccion">Detraccion (4%)</label>
              <input required id="detraccion" class="form-control disabled" type="number" step="0.01"
                aria-describedby="detraccionHelp" placeholder="Detraccion calculado" value="0.00" />
              <small id="detraccionHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- TOTAL -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="totalFacturado">Total</label>
              <input required id="totalFacturado" class="form-control disabled" type="number" step="0.01"
                aria-describedby="totalFacturaHelp" placeholder="Total a cobrar calculado" />
              <small id="totalFacturaHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>
          </div>
        </div>
      </div>
      <!--OPCIONES DEL FORMULARIO-->
      <div id="opcionesFormulario" class="form-inline justify-content-center">
        <button type="button" onclick="mostrarLoaderActualizar();return false" class="btn btn-reset">
          Actualizar
        </button>
      </div>
    </form>

    <!-- ESTADO 2 -->
    <form class="form-card">
      <!--DATOS FACTURA DEPOSITO -->
      <div class="card">
        <h5 class="card-header h5">Datos Depósito</h5>
        <div class="card-body">
          <div class="form-row">

            <input type="hidden" id="deposito" value="0">
            <div class="w-100"></div>

            <!-- FECHA DEPOSITO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="fechaDeposito">Fecha Deposito</label>
              <input required id="fechaDeposito" class="form-control " type="date" aria-describedby="fechaDepositoHelp"
                placeholder="Ingresar fecha deposito" />
              <small id="fechaDepositoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- ENTIDAD BANCARIA -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="entidadBancaria">Entidad Bancaria</label>
              <select required id="entidadBancaria" class="form-control" aria-describedby="entidadBancariaHelp">
                <option value="BCP">BCP</option>
                <option value="BBVA">BBVA</option>
                <option value="SCOTIABANK">SCOTIABANK</option>
                <option value="INTERBANK">INTERBANK</option>
                <option value="MIBANCO">MIBANCO</option>
              </select>
              <small id="entidadBancariaHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- FORMA DE PAGO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="formaPago">Forma de Pago</label>
              <select required id="formaPago" class="form-control" aria-describedby="formaPagoHelp">
                <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                <option value="DEPOSITO">DEPOSITO</option>
              </select>
              <small id="formaPagoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>

            <!-- NUMERO CENTRO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="numeroCentro">Numero Centro</label>
              <input required id="numeroCentro" class="form-control " type="number" aria-describedby="numeroCentroHelp"
                placeholder="Ingresar base imponible de la factura" />
              <small id="numeroCentroHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- NUMERO OPERACION -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="numeroOperacion">Numero Operacion</label>
              <input required id="numeroOperacion" class="form-control" type="number"
                aria-describedby="numeroOperacionHelp" placeholder="Numero operacion de la factura" />
              <small id="numeroOperacionHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>
          </div>
        </div>
      </div>
      <!--OPCIONES DEL FORMULARIO-->
      <div id="depositoRegistrar" class="form-inline justify-content-center">
        <button type="button" onclick="mostrarLoaderRegistrarDeposito();return false" class="btn btn-guardar">
          Registrar
        </button>
      </div>
      <div id="depositoActualizar" class="form-inline justify-content-center">
        <button type="button" onclick="mostrarLoaderActualizarDeposito();return false" class="btn btn-reset">
          Actualizar
        </button>
      </div>
    </form>

    <!-- ESTADO 3 -->
    <form class="form-card">
      <!--DATOS FACTURA NOTA CREDITO -->
      <div class="card">
        <h5 class="card-header h5">Datos Nota Crédito</h5>
        <div class="card-body">
          <div class="form-row">

            <input type="hidden" id="notaCredito" value="0">
            <div class="w-100"></div>

            <!-- FECHA DEPOSITO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="fechaNotaCredito">Fecha Nota Credito</label>
              <input required id="fechaNotaCredito" class="form-control " type="date"
                aria-describedby="fechaNotaCreditoHelp" placeholder="Ingresar fecha nota de credito" />
              <small id="fechaNotaCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- SERIE -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="serieNotaCredito">Serie Nota Credito</label>
              <input required id="serieNotaCredito" onkeyup="obtenerMayuscula(this);" class="form-control" type="string"
                aria-describedby="serieNotaCreditoHelp" placeholder="Ingresar serie de la nota de credito" />
              <small id="serieNotaCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- NUMERO -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="numeroNotaCredito">Numero Nota Credito</label>
              <input required id="numeroNotaCredito" onblur="autoCompletarCeros(this);" class="form-control"
                type="string" maxlength="8" aria-describedby="numeroNotaCreditoaHelp"
                placeholder="Ingresar numero de la nota de credito" />
              <small id="numeroNotaCreditoaHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>

            <!-- BASE IMPONIBLE -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="baseImponibleNotaCredito">Base Imponible</label>
              <input required id="baseImponibleNotaCredito" class="form-control " type="number" step="0.01"
                aria-describedby="baseImponibleNotaCreditoHelp"
                placeholder="Ingresar base imponible de la nota de credito" />
              <small id="baseImponibleNotaCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- IGV -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="igvNotaCredito">IGV (18%)</label>
              <input required id="igvNotaCredito" class="form-control disabled" type="number" step="0.01"
                aria-describedby="igvNotaCreditoHelp" placeholder="Igv calculado de la nota de credito" />
              <small id="igvNotaCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <!-- SUB TOTAL -->
            <div class="col-12 col-md form-group">
              <label class="col-form-label font-weight-bold" for="totalNotaCredito">Total Nota de credito</label>
              <input required id="totalNotaCredito" class="form-control " type="number" step="0.01"
                aria-describedby="totalNotaCreditoHelp" placeholder="Total calulado de la nota de credito" />
              <small id="totalNotaCreditoHelp" class="form-text text-muted">Campo obligatorio.</small>
            </div>

            <div class="w-100"></div>
          </div>
        </div>
      </div>
      <!--OPCIONES DEL FORMULARIO-->
      <div id="notaCreditoRegistrar" class="form-inline justify-content-center">
        <button type="button" onclick="mostrarLoaderRegistrarNotaCredito();return false" class="btn btn-guardar">
          Registrar
        </button>
      </div>
      <div id="notaCreditoActualizar" class="form-inline justify-content-center">
        <button type="button" onclick="mostrarLoaderActualizarNotaCredito();return false" class="btn btn-reset">
          Actualizar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="loader"></div>

<!--ARCHIVOS JS DE LA VISTA-->
<script src="Bootstrap/js/select2.min.js"></script>
<link href="Bootstrap/css/select2.min.css" rel="stylesheet" />
<script type="text/javascript" src="Modulos/ModContabilidad/VistaContabilidad.js"></script>
<script type="text/javascript" src="Bootstrap/js/tablaDinamica.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/validator/13.6.0/validator.min.js"></script>

<!-- SCRIPTS CARGA DE DOCUMENTOS -->
<script type="text/javascript">

  /*=============================================
    - CARGAR ESTADOS - DOCUMENTO
  =============================================*/
  $(document).ready(function () {
    guiasSeleccionadas = [];
    mostrarEstadosFactura();
    mostrarListadoFactura();
  });

  $("#factura").change(function () {
    const factura = $("#factura").val();
    if (factura.length !== 0) {
      document.getElementById("buscarFacturaButton").classList.remove("disabled");
    }
  });

  /*=============================================
    - MOSTRAR FORMULARIO POR ESTADO FACTURA
  =============================================*/

  $("#estadosFactura").change(function () {
    const estadosFactura = Number($("#estadosFactura").val());
    const estadoInicialFactura = Number($("#estadoInicialFactura").val());
    if (estadosFactura > estadoInicialFactura) {
      document.getElementById("actualizarEstadoFactura").classList.remove("disabled");
    } else {
      document.getElementById("actualizarEstadoFactura").classList.add("disabled");
    }
    if (estadosFactura === 2) {
      setTimeout(cargarDatosDeposito, 700);
    }
    if (estadosFactura === 3) {
      setTimeout(cargarDatosNotaCredito, 700);
    }
    const carousel = document.getElementById('carousel');
    const formWidth = document.querySelector('.form-card').clientWidth;
    carousel.style.transform = `translateX(${-(estadosFactura - 1) * formWidth}px)`;
  });

  /*=============================================
    - MOSTRAR CALCULO FACTURA
  =============================================*/

  $("#baseImponible").change(function () {
    const baseImponible = $("#baseImponible").val();
    if (baseImponible.length > 0) {
      const igv = Number(baseImponible) * 0.18;
      const subTotal = Number(baseImponible) * 1.18;
      $("#baseImponible").val(Number(baseImponible).toFixed(2));
      $("#igv").val(igv.toFixed(2));
      $("#subTotal").val(subTotal.toFixed(2));
      const usoDetraccion = $("#usoDetraccion").val();
      if (usoDetraccion === "SI") {
        const detraccion = Number(subTotal) * 0.04;
        const totalFacturado = Number(subTotal) * 0.96;
        $("#detraccion").val(detraccion.toFixed(2));
        $("#totalFacturado").val(totalFacturado.toFixed(2));
        $("#totalFacturado").val(subTotal.toFixed(2));
      } else {
        $("#detraccion").val("0.00");
        $("#totalFacturado").val(subTotal.toFixed(2));
      }
    } else {
      $("#baseImponible").val("0.00");
      $("#igv").val("0.00");
      $("#subTotal").val("0.00");
      $("#detraccion").val("0.00");
      $("#totalFacturado").val("0.00");
    }
  });

  $("#subTotal").change(function () {
    const subTotal = $("#subTotal").val();
    if (subTotal.length > 0) {
      const baseImponible = Number(subTotal) / 1.18;
      const igv = Number(baseImponible) * 0.18;
      $("#baseImponible").val(Number(baseImponible).toFixed(2));
      $("#igv").val(igv.toFixed(2));
      $("#subTotal").val(Number(subTotal).toFixed(2));
      const usoDetraccion = $("#usoDetraccion").val();
      if (usoDetraccion === "SI") {
        const detraccion = Number(subTotal) * 0.04;
        const totalFacturado = Number(subTotal) * 0.96;
        $("#detraccion").val(detraccion.toFixed(2));
        $("#totalFacturado").val(totalFacturado.toFixed(2));
      } else {
        $("#detraccion").val("0.00");
        $("#totalFacturado").val(Number(subTotal).toFixed(2));
      }
    } else {
      $("#baseImponible").val("0.00");
      $("#igv").val("0.00");
      $("#subTotal").val("0.00");
      $("#detraccion").val("0.00");
      $("#totalFacturado").val("0.00");
    }
  });

  $("#usoDetraccion").change(function () {
    const usoDetraccion = $("#usoDetraccion").val();
    const subTotal = $("#subTotal").val();
    if (usoDetraccion === "SI") {
      if (subTotal.length > 0) {
        const detraccion = Number(subTotal) * 0.04;
        const totalFacturado = Number(subTotal) * 0.96;
        $("#detraccion").val(detraccion.toFixed(2));
        $("#totalFacturado").val(totalFacturado.toFixed(2));
      }
    } else {
      if (subTotal.length > 0) {
        $("#detraccion").val("0.00");
        $("#totalFacturado").val(Number(subTotal).toFixed(2));
      }
    }
  });

  $("#baseImponibleNotaCredito").change(function () {
    const baseImponible = $("#baseImponibleNotaCredito").val();
    if (baseImponible.length > 0) {
      const igv = Number(baseImponible) * 0.18;
      const total = Number(baseImponible) * 1.18;
      $("#baseImponibleNotaCredito").val(Number(baseImponible).toFixed(2));
      $("#igvNotaCredito").val(igv.toFixed(2));
      $("#totalNotaCredito").val(total.toFixed(2));
    } else {
      $("#baseImponibleNotaCredito").val("0.00");
      $("#igvNotaCredito").val("0.00");
      $("#totalNotaCredito").val("0.00");
    }
  });

  $("#totalNotaCredito").change(function () {
    const total = $("#totalNotaCredito").val();
    if (total.length > 0) {
      const baseImponible = Number(total) / 1.18;
      const igv = Number(baseImponible) * 0.18;
      $("#totalNotaCredito").val(Number(total).toFixed(2));
      $("#igvNotaCredito").val(igv.toFixed(2));
      $("#baseImponibleNotaCredito").val(baseImponible.toFixed(2));
    } else {
      $("#baseImponibleNotaCredito").val("0.00");
      $("#igvNotaCredito").val("0.00");
      $("#totalNotaCredito").val("0.00");
    }
  });

  /*=============================================
    - MOSTRAR LOADER
  =============================================*/

  function mostrarLoader() {
    document.getElementById("loader").style.display = "block";
    setTimeout(mostrarDatosFactura, 1500);
  }

  function mostrarLoaderActualizarEstadoFactura() {
    document.getElementById("loader").style.display = "block";
    setTimeout(actualizarDatosEstadoFactura, 1500);
  }

  function mostrarLoaderActualizar() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarFormulario, 1500);
  }

  function mostrarLoaderRegistrarDeposito() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarFormularioDeposito, 1500);
  }

  function mostrarLoaderActualizarDeposito() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarFormularioActualizarDeposito, 1500);
  }

  function mostrarLoaderRegistrarNotaCredito() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarFormularioNotaCredito, 1500);
  }

  function mostrarLoaderActualizarNotaCredito() {
    document.getElementById("loader").style.display = "block";
    setTimeout(validarFormularioActualizarNotaCredito, 1500);
  }

  /*=============================================
    - CERRAR LOADER
  =============================================*/

  function cerrarLoader() {
    document.getElementById("loader").style.display = "none";
  }

  /*=============================================
    - MOSTRAR LISTADO FACTURA
  =============================================*/

  async function mostrarListadoFactura() {
    const datos = await cargarListadoFacturas();
    var tablaFactura = "<option value='0' selected disabled> Elegir Factura</option>";
    if (datos.response !== 1) {

      for (const factura of datos) {
        tablaFactura += `
            <option value=${factura.id_factura}>
              ${factura.serie_factura} - ${factura.numero_factura}
            </option>
          `;
      }
    }
    $("#factura").html(tablaFactura);
    $("#factura").select2();
  }

  /*=============================================
    - MOSTRAR ESTADOS FACTURA
  =============================================*/

  async function mostrarEstadosFactura() {
    const datos = await obtenerEstadosFactura();
    var tablaEstados = "";
    for (const estado of datos) {
      tablaEstados += `
          <option value=${estado.id_estado_factura}>
            ${estado.descripcion}
          </option>
        `;
    }
    $("#estadosFactura").html(tablaEstados);
  }

  /*=============================================
    - MOSTRAR DATOS FACTURA
  =============================================*/

  async function mostrarDatosFactura() {
    const datos = await cargarDatosFacturaId({
      _idFactura: $("#factura").val()
    });

    cerrarLoader();

    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Factura",
        text: "La factura no se encuentra registrada en la base de datos",
      });
    } else {
      document.getElementById("buscarDatos").classList.add("d-none");
      document.getElementById("informacionDatos").classList.remove("d-none");
      document.getElementById("carousel-factura").classList.remove("d-none");
      $("#codigo").html(`${datos.serie_factura} - ${datos.numero_factura}`);
      $("#fechaRegistro").html(datos.fecha_registro);
      $("#estadoInicialFactura").val(datos.id_estado_factura);
      $("#estadosFactura").val(datos.id_estado_factura);
      $("#serieFactura").val(datos.serie_factura);
      $("#numeroFactura").val(datos.numero_factura);
      $("#fechaVencimiento").val(datos.fecha_vencimiento);
      $("#tipoCredito").val(datos.tipo_credito);
      $("#ordenServicio").val(datos.orden_servicio);
      $("#baseImponible").val(datos.base_imponible);
      $("#igv").val(datos.igv);
      $("#subTotal").val(datos.subtotal);
      if (Number(datos.detraccion) === 0) {
        $("#usoDetraccion").val("NO");
      } else {
        $("#usoDetraccion").val("SI");
      }
      $("#detraccion").val(datos.detraccion);
      $("#totalFacturado").val(datos.total_cobrar);
      await mostrarDatosGuiaId(datos.id_guia);
      await mostrarGuiasFactura({ _idFactura: datos.id_factura });
      await mostrarGuiasSinFactura();

      await mostrarClienteSucursales();
      $("#cliente").val(datos.id_cliente_sucursal).trigger('change');

      if (datos.id_estado_factura === 2) {
        await cargarDatosDeposito();
      }

      if (datos.id_estado_factura === 3) {
        await cargarDatosNotaCredito();
      }

      const estadosFactura = Number(datos.id_estado_factura);
      const carousel = document.getElementById('carousel');
      const formWidth = document.querySelector('.form-card').clientWidth;
      carousel.style.transform = `translateX(${-(estadosFactura - 1) * formWidth}px)`;
    }
  }

  /*=============================================
    - MOSTRAR GUIAS SIN FACTURAR
  =============================================*/

  async function mostrarGuiasFactura($factura) {
    const datos = await cargarGuiasFactura($factura);
    var tablaGuias = "";
    if (Array.isArray(datos)) {
      guiasSeleccionadas = guiasSeleccionadas.concat(datos);
      for (const guia of datos) {
        const idGuia = encodeURIComponent(guia.id_guia);
        const serieGuia = encodeURIComponent(guia.serie_guia);
        const numeroGuia = encodeURIComponent(guia.numero_guia);
        const ordenCompra = encodeURIComponent(guia.orden_compra);
        const codigoCotizacion = encodeURIComponent(guia.codigo_cotizacion);

        tablaGuias += `<li>
                          <input type="checkbox" checked onchange="mostrarClienteSucursales();return false" name="guias" value="${idGuia}">
                          <div class="guia-item"><strong>GUIA</strong>: ${serieGuia} - ${numeroGuia}</div>
                          <div class="guia-item"><strong>ORDEN COMPRA</strong>: ${ordenCompra}</div>
                          <div class="guia-item"><strong>COTIZACION</strong>: ${codigoCotizacion}</div>
                      </li>`;
      }
    }
    $("#guiaList").html(tablaGuias);
  }

  /*=============================================
    - MOSTRAR GUIAS SIN FACTURAR
  =============================================*/

  async function mostrarGuiasSinFactura() {
    const datos = await cargarGuiasSinFactura();
    var tablaGuias = "";
    if (Array.isArray(datos)) {
      for (const guia of datos) {
        const idGuia = encodeURIComponent(guia.id_guia);
        const serieGuia = encodeURIComponent(guia.serie_guia);
        const numeroGuia = encodeURIComponent(guia.numero_guia);
        const ordenCompra = encodeURIComponent(guia.orden_compra);
        const codigoCotizacion = encodeURIComponent(guia.codigo_cotizacion);

        tablaGuias += `<li>
                          <input type="checkbox" onchange="mostrarClienteSucursales();return false" name="guias" value="${idGuia}">
                          <div class="guia-item"><strong>GUIA</strong>: ${serieGuia} - ${numeroGuia}</div>
                          <div class="guia-item"><strong>ORDEN COMPRA</strong>: ${ordenCompra}</div>
                          <div class="guia-item"><strong>COTIZACION</strong>: ${codigoCotizacion}</div>
                      </li>`;
      }
    }
    $("#guiaList").append(tablaGuias);
  }

  /*ss=============================================
    - FILTRAR GUIAS
  =============================================*/

  function filtrarGuias() {
    const input = document.getElementById('buscarGuia').value.toLowerCase();
    const items = document.querySelectorAll('#guiaList li');

    items.forEach(item => {
      const texto = item.textContent.toLowerCase();
      item.style.display = texto.includes(input) ? '' : 'none';
    });
  }

  /*=============================================
    - MOSTRAR CLIENTE SUCURSALES
  =============================================*/

  async function mostrarClienteSucursales() {

    const checkboxes = document.querySelectorAll('input[name="guias"]:checked');
    const guias = Array.from(checkboxes).map(checkbox => ({ id_guia: Number(checkbox.value) }));
    const clientes = []
    var tablaSucursales = "<option value = '0' selected disabled> Elegir Guia</option>";
    if (guias.length > 0) {

      for await (const guia of guias) {
        const datos = await cargarDatosGuiaId({ _idGuia: guia.id_guia });
        clientes.push(datos.id_cliente);
      }
      const sucursales = new Set(clientes);
      const resultado = await cargarListadoClienteSucursales({ _idCliente: Array.from(sucursales).toString() });
      tablaSucursales = "<option value = '0' selected disabled> Elegir Cliente</option>";
      for (const sucursal of resultado) {
        tablaSucursales += `<option value='${sucursal.id_cliente_sucursal}'> ${sucursal.ruc} ${sucursal.razon_social}</option>`;
      }
    }
    const cliente = Number($("#cliente").val() ?? 0);
    $("#cliente").html(tablaSucursales);
    $("#cliente").select2();
    $("#cliente").val(cliente).trigger('change');
  }

  /*=============================================
    - ACTUALIZAR DATOS ESTADO FACTURA
  =============================================*/

  async function actualizarDatosEstadoFactura() {
    const datos = await actualizarEstadoFactura({
      _idFactura: $("#factura").val(),
      _idEstadoFactura: $("#estadosFactura").val()
    });

    cerrarLoader();

    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Factura",
        text: datos.message,
      });
    } else {
      Swal.fire({
        icon: "success",
        title: "Factura actualizada",
        text: datos.message,
      });
      $("#estadoInicialFactura").val($("#estadosFactura").val())
    }
  }

  /*=============================================
    - MOSTRAR DATOS GUIA
  =============================================*/

  async function mostrarDatosGuiaId(id_guia) {
    const datos = await cargarDatosGuiaId({
      _idGuia: id_guia
    });
    const tablaProducto = `
      <option value='${datos.id_guia}' selected >
        ${datos.serie_guia} - ${datos.numero_guia}
      </option>
    `;
    $("#guia").html(tablaProducto);
  }

  /*=============================================
    - VALIDAR DATOS FACTURA
  =============================================*/

  async function validarFormulario() {
    const factura = $("#factura").val();
    const serie = $("#serieFactura").val();
    const numero = $("#numeroFactura").val();
    const cliente = $("#cliente").val();
    const fechaVencimiento = $("#fechaVencimiento").val();
    const tipoCredito = $("#tipoCredito").val();
    const ordenServicio = $("#ordenServicio").val();
    const baseImponible = $("#baseImponible").val();
    const igv = $("#igv").val();
    const subTotal = $("#subTotal").val();
    const detraccion = $("#detraccion").val();
    const totalFacturado = $("#totalFacturado").val();
    const checkboxes = document.querySelectorAll('input[name="guias"]:checked');
    const guias = Array.from(checkboxes).map(checkbox => ({ id_guia: Number(checkbox.value) }));
    const info = {
      icon: "error",
      title: "Campo Inválido",
    };

    if (guias.length === 0) {
      info.text = "La guia debe ser seleccionada";
    } else if (!validator.isLength(fechaVencimiento, { min: 8 })) {
      info.text = "El campo fecha de vencimiento debe ser seleccionado";
    } else if (!validator.isLength(baseImponible, { min: 1 })) {
      info.text = "El campo base imponible no puede estar vacío";
    } else if (!validator.isLength(igv, { min: 1 })) {
      info.text = "El campo igv no puede estar vacío";
    } else if (!validator.isLength(subTotal, { min: 1 })) {
      info.text = "El campo subtotal no puede estar vacío";
    } else if (Number(baseImponible) === 0) {
      info.text = "La base imponible no puede ser 0.00";
    }

    const guiasRevisadas = guias.map(item => {
      const verificarExistencia = guiasSeleccionadas.find(guia => guia.id_guia === item.id_guia);
      if (verificarExistencia) {
        return {
          id_guia: verificarExistencia.id_guia,
          id_guia_factura: verificarExistencia.id_guia_factura,
        }
      } else {
        return { ...item };
      }
    })

    if (info.text) {
      cerrarLoader();
      Swal.fire(info);
      return false;
    }

    await actualizarDatosFactura({
      _idFactura: factura,
      _serie: serie,
      _numero: numero,
      _cliente: cliente,
      _fechaVencimiento: fechaVencimiento,
      _tipoCredito: tipoCredito,
      _ordenServicio: ordenServicio,
      _baseImponible: baseImponible,
      _igv: igv,
      _subtotal: subTotal,
      _detraccion: detraccion,
      _total: totalFacturado
    }, {
      _idFactura: factura,
      _guias: guiasRevisadas
    });
  }

  /*=============================================
    - ACTUALIZAR DATOS FACTURA
  =============================================*/

  async function actualizarDatosFactura($factura, $guias) {
    const datos = await actualizarFactura($factura);
    await eliminarDatosGuiasFactura($guias);
    await registrarDatosGuiasFactura($guias);
    cerrarLoader();
    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Factura",
        text: datos.message
      });
    } else {
      ventanaFacturaActualizar();
      Swal.fire({
        icon: "success",
        title: "Factura actualizada",
        text: datos.message
      });
    }
  }

  /*=============================================
    - VALIDAR FACTURA - DEPOSITO
  =============================================*/

  async function validarFormularioDeposito() {
    const idFactura = $("#factura").val();
    const fechaDeposito = $("#fechaDeposito").val();
    const entidadBancaria = $("#entidadBancaria").val();
    const formaPago = $("#formaPago").val();
    const numeroCentro = $("#numeroCentro").val();
    const numeroOperacion = $("#numeroOperacion").val();

    await registrarDatosDeposito({
      _idFactura: idFactura,
      _fechaDeposito: fechaDeposito,
      _entidadBancaria: entidadBancaria,
      _formaPago: formaPago,
      _numeroCentro: numeroCentro,
      _numeroOperacion: numeroOperacion
    });
  }

  /*=============================================
    - REGISTRAR DATOS FACTURA - DEPOSITO
  =============================================*/

  async function registrarDatosDeposito($deposito) {
    const datos = await registrarDeposito($deposito);
    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Deposito",
        text: datos.message
      });
    } else {
      cerrarLoader();
      await cargarDatosDeposito();
      Swal.fire({
        icon: "success",
        title: "Deposito registrado",
        text: datos.message
      });
    }
  }

  /*=============================================
    - VALIDAR FACTURA - ACTUALIZAR DEPOSITO
  =============================================*/

  async function validarFormularioActualizarDeposito() {
    const idFacturaDeposito = $("#deposito").val();
    const idFactura = $("#factura").val();
    const fechaDeposito = $("#fechaDeposito").val();
    const entidadBancaria = $("#entidadBancaria").val();
    const formaPago = $("#formaPago").val();
    const numeroCentro = $("#numeroCentro").val();
    const numeroOperacion = $("#numeroOperacion").val();

    await actualizarDatosDeposito({
      _idFacturaDeposito: idFacturaDeposito,
      _idFactura: idFactura,
      _fechaDeposito: fechaDeposito,
      _entidadBancaria: entidadBancaria,
      _formaPago: formaPago,
      _numeroCentro: numeroCentro,
      _numeroOperacion: numeroOperacion
    });
  }

  /*=============================================
    - ACTUALIZAR DATOS FACTURA - DEPOSITO
  =============================================*/

  async function actualizarDatosDeposito($deposito) {
    const datos = await actualizarDeposito($deposito);
    cerrarLoader();
    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Deposito",
        text: datos.message
      });
    } else {
      Swal.fire({
        icon: "success",
        title: "Deposito registrado",
        text: datos.message
      });
    }
  }

  /*=============================================
    - MOSTRAR DATOS FACTURA - DEPOSITO
  =============================================*/

  async function cargarDatosDeposito() {
    const datos = await cargarDepositoIdFactura({
      _idFactura: $("#factura").val()
    });
    if (datos.response === 0) {
      document.querySelector("#fechaDeposito").valueAsDate = new Date();
      document.getElementById("depositoActualizar").classList.add("d-none");
      document.getElementById("depositoRegistrar").classList.remove("d-none");
      document.getElementById("actualizarEstadoFactura").classList.add("disabled");
    } else {
      document.getElementById("depositoActualizar").classList.remove("d-none");
      document.getElementById("depositoRegistrar").classList.add("d-none");
      document.getElementById("actualizarEstadoFactura").classList.remove("disabled");
      $("#deposito").val(datos.id_factura_deposito);
      $("#fechaDeposito").val(datos.fecha_deposito);
      $("#entidadBancaria").val(datos.entidad_bancaria);
      $("#formaPago").val(datos.forma_pago);
      $("#numeroCentro").val(datos.numero_centro);
      $("#numeroOperacion").val(datos.numero_operacion);
    }
  }

  /*=============================================
    - VALIDAR NOTA CREDITO
  =============================================*/

  async function validarFormularioNotaCredito() {
    const idFactura = $("#factura").val();
    const fechaNotaCredito = $("#fechaNotaCredito").val();
    const serieNotaCredito = $("#serieNotaCredito").val();
    const numeroNotaCredito = $("#numeroNotaCredito").val();
    const baseImponibleNotaCredito = $("#baseImponibleNotaCredito").val();
    const igvNotaCredito = $("#igvNotaCredito").val();
    const totalNotaCredito = $("#totalNotaCredito").val();

    const info = {
      icon: "error",
      title: "Campo Inválido",
    };

    if (!validator.isLength(fechaNotaCredito, { min: 8 })) {
      info.text = "El campo fecha de nota de credito debe ser seleccionado";
    } else if (!validator.isLength(serieNotaCredito, { min: 2 })) {
      info.text = "El campo serie nota de credito debe tener una longitud minima de 2 caracteres";
    } else if (!validator.isLength(numeroNotaCredito, { min: 1 })) {
      info.text = "El campo numero nota de credito no debe ir vacio";
    } else if (!validator.isLength(baseImponibleNotaCredito, { min: 1 })) {
      info.text = "El campo base imponible no debe ir vacio";
    } else if (!validator.isLength(igvNotaCredito, { min: 1 })) {
      info.text = "El campo igv no debe ir vacio";
    } else if (!validator.isLength(totalNotaCredito, { min: 1 })) {
      info.text = "El campo total no debe ir vacio";
    }

    if (info.text) {
      cerrarLoader();
      Swal.fire(info);
      return false;
    }

    await registrarDatosNotaCredito({
      _idFactura: idFactura,
      _fechaNotaCredito: fechaNotaCredito,
      _serieNotaCredito: serieNotaCredito,
      _numeroNotaCredito: numeroNotaCredito,
      _baseImponible: baseImponibleNotaCredito,
      _igv: igvNotaCredito,
      _total: totalNotaCredito
    });
  }

  /*=============================================
    - REGISTRAR DATOS NOTA CREDITO
  =============================================*/

  async function registrarDatosNotaCredito($notaCredito) {
    const datos = await registrarNotaCredito($notaCredito);
    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Nota de credito",
        text: datos.message
      });
    } else {
      cerrarLoader();
      await cargarDatosNotaCredito();
      Swal.fire({
        icon: "success",
        title: "Nota de credito",
        text: datos.message
      });
    }
  }

  /*=============================================
    - VALIDAR NOTA CREDITO - ACTUALIZAR
  =============================================*/

  async function validarFormularioActualizarNotaCredito() {
    const idNotaCredito = $("#notaCredito").val();
    const idFactura = $("#factura").val();
    const fechaNotaCredito = $("#fechaNotaCredito").val();
    const serieNotaCredito = $("#serieNotaCredito").val();
    const numeroNotaCredito = $("#numeroNotaCredito").val();
    const baseImponibleNotaCredito = $("#baseImponibleNotaCredito").val();
    const igvNotaCredito = $("#igvNotaCredito").val();
    const totalNotaCredito = $("#totalNotaCredito").val();

    const info = {
      icon: "error",
      title: "Campo Inválido",
    };

    if (!validator.isLength(fechaNotaCredito, { min: 8 })) {
      info.text = "El campo fecha de nota de credito debe ser seleccionado";
    } else if (!validator.isLength(serieNotaCredito, { min: 2 })) {
      info.text = "El campo serie nota de credito debe tener una longitud minima de 2 caracteres";
    } else if (!validator.isLength(numeroNotaCredito, { min: 1 })) {
      info.text = "El campo numero nota de credito no debe ir vacio";
    } else if (!validator.isLength(baseImponibleNotaCredito, { min: 1 })) {
      info.text = "El campo base imponible no debe ir vacio";
    } else if (!validator.isLength(igvNotaCredito, { min: 1 })) {
      info.text = "El campo igv no debe ir vacio";
    } else if (!validator.isLength(totalNotaCredito, { min: 1 })) {
      info.text = "El campo total no debe ir vacio";
    }

    if (info.text) {
      cerrarLoader();
      Swal.fire(info);
      return false;
    }

    await actualizarDatosNotaCredito({
      _idNotaCredito: idNotaCredito,
      _idFactura: idFactura,
      _fechaNotaCredito: fechaNotaCredito,
      _serieNotaCredito: serieNotaCredito,
      _numeroNotaCredito: numeroNotaCredito,
      _baseImponible: baseImponibleNotaCredito,
      _igv: igvNotaCredito,
      _total: totalNotaCredito
    });
  }

  /*=============================================
    - REGISTRAR DATOS NOTA CREDITO
  =============================================*/

  async function actualizarDatosNotaCredito($notaCredito) {
    const datos = await actualizarNotaCredito($notaCredito);
    if (datos.response === 0) {
      Swal.fire({
        icon: "error",
        title: "Nota de credito",
        text: datos.message
      });
    } else {
      cerrarLoader();
      await cargarDatosNotaCredito();
      Swal.fire({
        icon: "success",
        title: "Nota de credito",
        text: datos.message
      });
    }
  }

  /*=============================================
    - MOSTRAR DATOS FACTURA - NOTA CREDITO
  =============================================*/

  async function cargarDatosNotaCredito() {
    const datos = await cargarNotaCreditoIdFactura({
      _idFactura: $("#factura").val()
    });
    if (datos.response === 0) {
      document.querySelector("#fechaNotaCredito").valueAsDate = new Date();
      document.getElementById("notaCreditoActualizar").classList.add("d-none");
      document.getElementById("notaCreditoRegistrar").classList.remove("d-none");
      document.getElementById("actualizarEstadoFactura").classList.add("disabled");
    } else {
      document.getElementById("notaCreditoActualizar").classList.remove("d-none");
      document.getElementById("notaCreditoRegistrar").classList.add("d-none");
      document.getElementById("actualizarEstadoFactura").classList.remove("disabled");
      $("#notaCredito").val(datos.id_nota_credito);
      $("#fechaNotaCredito").val(datos.fecha_nota_credito);
      $("#serieNotaCredito").val(datos.serie_nota_credito);
      $("#numeroNotaCredito").val(datos.numero_nota_credito);
      $("#baseImponibleNotaCredito").val(datos.base_imponible);
      $("#igvNotaCredito").val(datos.igv);
      $("#totalNotaCredito").val(datos.total);
    }
  }


</script>